name: Deploy MkDocs to PyEyesWeb GitHub Pages

on:
  push:
    branches:
      - main   # branch of your docs repo (pyeyesweb_doc)

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the docs repository (this one)
      - name: Checkout docs repository
        uses: actions/checkout@v4

      # 2. Checkout the source code repository into a subfolder
      - name: Checkout PyEyesWeb source code
        uses: actions/checkout@v4
        with:
          repository: InfoMusCP/PyEyesWeb
          path: PyEyesWeb   # now code is available in ./PyEyesWeb/core

      # 3. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 4. Install dependencies from your docs repo
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 5. Debug - Check Python path and structure
      - name: Debug - Check Python path and structure
        run: |
          echo "=== Directory Structure ==="
          ls -la PyEyesWeb/
          echo "=== Core Package ==="
          ls -la PyEyesWeb/core/
          echo "=== Data Models ==="
          ls -la PyEyesWeb/core/data_models/ || echo "data_models directory not found"
          echo "=== Python Environment ==="
          python -c "import sys; print('Python path:', sys.path)"
          echo "Current PYTHONPATH: $PYTHONPATH"

      #echo "=== Test Import ==="
      #cd PyEyesWeb && python -c "import core; print('Core module imported successfully')" || echo "Failed to import core module"

      # 6. Build docs with proper PYTHONPATH
      - name: Build MkDocs site
        env:
          PYTHONPATH: ${{ github.workspace }}/PyEyesWeb
        run: |
          echo "Building with PYTHONPATH: $PYTHONPATH"
          # Build the docs
          mkdocs build --verbose

      # 7. Deploy the built site to GitHub Pages
      - name: Deploy to GitHub Pages ðŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: InfoMusCP/PyEyesWeb
          publish_dir: ./site
          publish_branch: gh-pages
          personal_token: ${{ secrets.DEPLOY_TOKEN }}
          force_orphan: true
          enable_jekyll: false